name: Dependency Upgrade Scanner

on:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches:
      - main
    paths:
      - 'requirements.txt'

jobs:
  scan-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Scan for dependency upgrades
        id: scan
        run: |
          python scan_upgrades.py --json upgrade_report.json
          echo "UPGRADE_COUNT=$(python scan_upgrades.py | grep 'Summary:' | grep -oE '[0-9]+' | head -1)" >> $GITHUB_OUTPUT
      
      - name: Upload upgrade report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-upgrade-report
          path: upgrade_report.json
          retention-days: 90
      
      - name: Create issue if upgrades available
        if: steps.scan.outputs.UPGRADE_COUNT != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('upgrade_report.json', 'utf8'));
            
            const upgradePackages = report.filter(pkg => pkg.status === 'upgrade-available');
            
            if (upgradePackages.length === 0) {
              console.log('No upgrades available');
              return;
            }
            
            // Create markdown table
            let body = '## Dependency Upgrades Available\n\n';
            body += `Found ${upgradePackages.length} package(s) with available upgrades:\n\n`;
            body += '| Package | Current | Latest |\n';
            body += '|---------|---------|--------|\n';
            
            upgradePackages.forEach(pkg => {
              body += `| ${pkg.package} | ${pkg.current} | ${pkg.latest} |\n`;
            });
            
            body += '\n### Next Steps\n';
            body += '1. Review the upgrade report artifact\n';
            body += '2. Test upgrades in a development environment\n';
            body += '3. Update `requirements.txt` with compatible versions\n';
            body += '4. Run tests to ensure compatibility\n\n';
            body += '> This issue was automatically created by the Dependency Upgrade Scanner workflow.';
            
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies',
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Dependency Upgrades Available')
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated Scan Results\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Dependency Upgrades Available',
                body: body,
                labels: ['dependencies', 'enhancement']
              });
              console.log(`Created issue #${issue.data.number}`);
            }
      
      - name: Comment on PR if triggered by push
        if: github.event_name == 'push' && steps.scan.outputs.UPGRADE_COUNT != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('upgrade_report.json', 'utf8'));
            const upgradePackages = report.filter(pkg => pkg.status === 'upgrade-available');
            
            if (upgradePackages.length > 0) {
              console.log(`Found ${upgradePackages.length} packages with upgrades after requirements.txt change`);
            }
